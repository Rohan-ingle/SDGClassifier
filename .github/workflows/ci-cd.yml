name: Fast CI-CD for Azure

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  PYTHON_VERSION: "3.10"
  DOCKER_IMAGE_NAME: sdg-classifier

jobs:
  test-and-train:
    name: Test & Train Model
    runs-on: ubuntu-latest
    env:
      AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install 'dvc[azure]>=2.40.0'

      - name: Pull DVC data
        run: |
          dvc remote modify --local azurestorage connection_string "$AZURE_STORAGE_CONNECTION_STRING"
          dvc pull

      - name: Run preprocessing
        run: |
          echo "Starting data preprocessing..."
          python -m src.data.preprocess
          echo "Preprocessing completed"

      - name: Run training
        run: |
          echo "Starting model training..."
          python -m src.models.train
          echo "Training completed"

      - name: Run evaluation
        run: |
          echo "Starting model evaluation..."
          python -m src.evaluation.evaluate
          echo "Evaluation completed"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ github.sha }}
          path: |
            logs/
          retention-days: 30
          if-no-files-found: warn

      - name: Upload metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: metrics-${{ github.sha }}
          path: |
            metrics/
            models/training_metrics.json
            models/model_metadata.json
            data/processed/data_stats.json
          retention-days: 30
          if-no-files-found: warn

      - name: Upload trained models
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: models-${{ github.sha }}
          path: |
            models/*.pkl
            models/*.json
          retention-days: 30
          if-no-files-found: warn

  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    needs: test-and-train
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    env:
      AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install 'dvc[azure]>=2.40.0'

      - name: Pull DVC data
        run: |
          dvc remote modify --local azurestorage connection_string "$AZURE_STORAGE_CONNECTION_STRING"
          dvc pull

      - name: Download trained models
        uses: actions/download-artifact@v4
        with:
          name: models-${{ github.sha }}
          path: models/

      - name: Azure login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ACR login
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Build & push image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${IMAGE_TAG} .
          docker push ${{ secrets.ACR_NAME }}.azurecr.io/${{ env.DOCKER_IMAGE_NAME }}:${IMAGE_TAG}

      - name: Set AKS context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ secrets.AKS_CLUSTER_NAME }}

      - name: Deploy to AKS
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Replace placeholders in deployment.yaml
          sed -i "s/\${ACR_NAME}/${{ secrets.ACR_NAME }}/g" k8s/deployment.yaml
          sed -i "s/\${IMAGE_TAG}/${IMAGE_TAG}/g" k8s/deployment.yaml
          
          # Deploy to AKS
          kubectl apply -f k8s/deployment.yaml
          kubectl rollout status deployment/sdg-classifier-deployment --timeout=300s

      - name: Upload deployment logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs-${{ github.sha }}
          path: |
            logs/
          retention-days: 30
          if-no-files-found: warn
